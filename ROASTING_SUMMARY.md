# التحميص - ملخص مختصر

## إضافة فاتورة التحميص

عند الإنشاء:
- يتم حجز الكمية من المنتج الخام (تقليل `AvailableQty` فقط)
- لا يتم استهلاك الكمية بعد

---

## ترحيل فاتورة التحميص

عند الترحيل:

### المدخلات من الفرونت إند:
- **ActualQuantityAfterRoasting**: الكمية الفعلية بعد التحميص (بالكيلو)
- **SalePricePerKg**: سعر البيع للكيلو (بالدولار) ⭐ **من الفرونت إند**
- **RoastingCostPerKg**: تكلفة التحميص للكيلو (بالليرة السورية)
- **CommissionPerKg**: العمولة للكيلو (بالدولار)

### العمليات في الباك إند:

1. **استهلاك المنتج الخام**:
   - تقليل `Qty` من `ProductBalance` للمنتج الخام
   - الكمية المستهلكة: `detail.QuantityKg`

2. **حساب القيمة للمنتج المحمص**:
   ```
   rawConsumedValue = rawAvgCost × detail.QuantityKg  // قيمة الخام المستخدم (بالدولار)
   commissionValue = CommissionPerKg × ActualQuantityAfterRoasting  // قيمة العمولة (بالدولار)
   totalValue = rawConsumedValue + commissionValue  // القيمة الإجمالية (بالدولار)
   ```

3. **إضافة المنتج المحمص للمخزون**:
   - زيادة `Qty` بالكمية الفعلية (`ActualQuantityAfterRoasting`)
   - زيادة `AvailableQty` بالكمية الفعلية
   - زيادة `TotalValue` بالقيمة المحسوبة (`totalValue`)
   - تحديث `AverageCost` تلقائياً: `AverageCost = TotalValue / Qty`

4. **تخزين سعر البيع**:
   - **SalePrice = SalePricePerKg** (يأتي من الفرونت إند، بالدولار)
   - يتم تخزينه في `ProductBalance.SalePrice`

5. **تحديث رصيد الموظف**:
   - حساب إجمالي تكلفة التحميص: `totalRoastingCost = sum(Receipts.TotalRoastingCost)`
   - زيادة رصيد الموظف بالليرة السورية: `employee.SyrianMoney += totalRoastingCost`

---

## ملخص:

- **المنتج الخام**: يتم استهلاكه من المخزون (تقليل `Qty` و `TotalValue`)
- **المنتج المحمص**: يتم إضافته للمخزون مع:
  - **AverageCost** (بالدولار): محسوب من (قيمة الخام المستهلك + قيمة العمولة) / الكمية الفعلية
  - **SalePrice** (بالدولار): يأتي من الفرونت إند (`SalePricePerKg`)
- **تكلفة التحميص**: بالليرة السورية، يتم إضافتها لرصيد الموظف
- **جميع القيم**: بالدولار (لا يوجد تحويل)
- **سعر البيع**: يأتي من الفرونت إند، لا يتم حسابه في الباك إند

---

## نقاط مهمة:

1. **قيمة الخام المستهلك**: تُحسب من **الكمية المستهلكة** (`detail.QuantityKg`)
2. **قيمة العمولة**: تُحسب من **الكمية الفعلية الناتجة** (`ActualQuantityAfterRoasting`)
3. **AverageCost**: يُحسب من (قيمة الخام + قيمة العمولة) / **الكمية الفعلية الناتجة**
4. **الكمية الفعلية**: قد تكون أقل من الكمية المستهلكة بسبب فقدان الوزن أثناء التحميص
5. **سعر البيع**: يأتي دائماً من الفرونت إند، لا يتم حسابه في الباك إند
