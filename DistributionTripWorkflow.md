# سيناريو عمل رحلات التوزيع في MarketZone (محدث)

## 📋 نظرة عامة

سيناريو عمل رحلات التوزيع يتضمن إدارة شاملة لعملية توزيع المنتجات من المستودع إلى العملاء عبر الموزعين.

## 🔄 دورة حياة رحلة التوزيع (محدثة)

### **المرحلة الأولى: إنشاء رحلة التوزيع**
```
1. إنشاء رحلة توزيع جديدة
2. تحديد الموظف المسؤول
3. اختيار السيارة المناسبة
4. تحديد المنطقة المستهدفة
5. تحديد تاريخ الرحلة
6. إضافة المنتجات والكميات المطلوبة
```

**API:** `POST /api/DistributionTrip/CreateDistributionTrip`

### **المرحلة الثانية: ترحيل الرحلة**
```
- تغيير حالة الرحلة من "مسودة" إلى "مرحلة"
- إعداد الرحلة للتنفيذ
- تنقص الكميات من المخزون المتاح
```

**API:** `PUT /api/DistributionTrip/PostDistributionTrip`

### **المرحلة الثالثة: استلام البضاعة (محدثة)**
```
- عودة الموظف من الرحلة
- تسجيل الكميات المرجعة فقط لكل منتج
- تغيير حالة الرحلة إلى "تم استلام البضاعة"
```

**API:** `PUT /api/DistributionTrip/ReceiveGoods`

### **المرحلة الرابعة: إنشاء فواتير المبيعات (محدثة)**
```
- إنشاء فواتير مبيعات من نوع "مبيع موزع"
- يمكن إنشاء فواتير من واجهة فواتير المبيعات العادية مع تحديد النوع
- كل فاتورة تضيف الكمية المباعة للمنتج تلقائياً في رحلة التوزيع
- ربط الفواتير برحلة التوزيع
```

**API:** `POST /api/SalesInvoice/CreateSalesInvoice` (مع `Type: Distributor`)

### **المرحلة الخامسة: التحقق من الكميات**
```
- التحقق من صحة الكميات المسجلة
- التأكد من عدم وجود نقص أو زيادة
- عرض التحذيرات والأخطاء إن وجدت
```

**API:** `GET /api/DistributionTrip/ValidateTripQuantities`

### **المرحلة السادسة: إكمال الرحلة**
```
- التحقق من اكتمال جميع العمليات
- تغيير حالة الرحلة إلى "مكتملة"
- تنقص الكميات من المخزون الموجود
```

**API:** `PUT /api/DistributionTrip/CompleteTrip`

## 📊 حالات رحلة التوزيع

| الحالة | الوصف | العمليات المسموحة |
|--------|--------|-------------------|
| **Draft** | مسودة | تعديل، حذف |
| **Posted** | مرحلة | استلام البضاعة |
| **InProgress** | قيد التنفيذ | - |
| **GoodsReceived** | تم استلام البضاعة | إنشاء فواتير، إكمال الرحلة |
| **Completed** | مكتملة | عرض فقط |
| **Cancelled** | ملغية | عرض فقط |

## 🗂️ الحقول الجديدة

### **DistributionTrip**
- `Status`: حالة الرحلة (enum)
- `Details`: قائمة تفاصيل الرحلة
- `DistributionTripSalesInvoices`: فواتير المبيعات المرتبطة بالرحلة

### **DistributionTripDetail**
- `Qty`: الكمية المحملة
- `ExpectedPrice`: السعر المتوقع
- `ReturnedQty`: الكمية المرجعة (تُخزن في قاعدة البيانات)
- `SoldQty`: الكمية المباعة (تُحدث عند إضافة فواتير المبيعات)

### **SalesInvoice (محدث)**
- `Type`: نوع الفاتورة (Regular/Distributor)
- `DistributionTripId`: ربط برحلة التوزيع (اختياري)

## 🔧 API Endpoints

### **إدارة الرحلات**
```
GET    /api/DistributionTrip/GetPagedListDistributionTrip
POST   /api/DistributionTrip/CreateDistributionTrip
PUT    /api/DistributionTrip/UpdateDistributionTrip
```

### **سير العمل**
```
PUT    /api/DistributionTrip/PostDistributionTrip
PUT    /api/DistributionTrip/ReceiveGoods
PUT    /api/DistributionTrip/CompleteTrip
```

### **التحقق والتحليل**
```
GET    /api/DistributionTrip/ValidateTripQuantities
```

### **فواتير المبيعات (محدثة)**
```
POST   /api/SalesInvoice/CreateSalesInvoice (مع Type: Distributor)
GET    /api/SalesInvoice/GetPagedListSalesInvoice
PUT    /api/SalesInvoice/UpdateSalesInvoice
```

## 📝 أمثلة على الاستخدام

### **إنشاء رحلة توزيع**
```json
{
  "employeeId": 1,
  "carId": 1,
  "regionId": 1,
  "tripDate": "2025-01-15",
  "loadQty": 500,
  "notes": "رحلة توزيع للمنطقة الشمالية",
  "details": [
    {
      "productId": 1,
      "qty": 100,
      "expectedPrice": 25.50
    },
    {
      "productId": 2,
      "qty": 50,
      "expectedPrice": 30.00
    }
  ]
}
```

### **استلام البضاعة (محدث)**
```json
{
  "tripId": 1,
  "details": [
    {
      "detailId": 1,
      "returnedQty": 15
    },
    {
      "detailId": 2,
      "returnedQty": 5
    }
  ]
}
```

### **إنشاء فاتورة مبيعات موزع**
```json
{
  "invoiceNumber": "INV-001",
  "customerId": 1,
  "invoiceDate": "2025-01-15",
  "totalAmount": 765.00,
  "discount": 0,
  "paymentMethod": "نقدي",
  "notes": "فاتورة توزيع",
  "type": "Distributor",
  "distributionTripId": 1,
  "details": [
    {
      "productId": 1,
      "quantity": 30,
      "unitPrice": 25.50,
      "subTotal": 765.00,
      "notes": "طلب عادي"
    }
  ]
}
```

**ملاحظة**: عند إنشاء هذه الفاتورة، سيتم تحديث `SoldQty` للمنتج رقم 1 في رحلة التوزيع رقم 1 بإضافة 30.

## ⚠️ التحقق من الكميات (محدث)

### **الأخطاء (Errors)**
- الكمية المباعة (المحدثة) + الكمية المرجعة > الكمية المحملة
- عدم تسجيل أي كميات

### **التحذيرات (Warnings)**
- الكمية المرجعة > 30% من الكمية المحملة
- عدم تسجيل أي مبيعات أو مرتجعات

## 🔗 التكامل مع الأنظمة الأخرى

### **مع نظام المبيعات**
- إنشاء فواتير مبيعات من نوع "مبيع موزع"
- ربط الفواتير برحلات التوزيع
- تحديث الكميات المباعة تلقائياً عند إنشاء الفواتير

### **مع نظام المخزون**
- عند **ترحيل الرحلة** → تنقص من **الكمية المتاحة**
- عند **إكمال الرحلة** → تنقص من **الكمية الموجودة**
- **فواتير المبيعات** لا تؤثر على المخزون مباشرة

### **مع نظام المحاسبة**
- تتبع إيرادات التوزيع
- حساب تكاليف النقل
- تمييز فواتير الموزعين عن الفواتير العادية

## 📈 التقارير المتاحة

1. **تقرير رحلات التوزيع**
   - رحلات/موظف
   - رحلات/سيارة
   - رحلات/منطقة

2. **تقرير أداء الموزعين**
   - كميات مباعة/موزع (من الفواتير المحدثة)
   - كميات مرجعة/موزع
   - نسبة المبيعات

3. **تقرير تحليل الكميات**
   - مقارنة الكميات المحملة والمباعة
   - تحليل المرتجعات
   - تحديد المنتجات الأكثر طلباً

4. **تقرير فواتير الموزعين**
   - فواتير/رحلة توزيع
   - إيرادات/موزع
   - تحليل المبيعات حسب النوع

## 🔄 سير العمل الجديد

```
إنشاء رحلة → ترحيل (تنقص من المتاح) → استلام البضاعة (المرتجعات فقط) → 
إنشاء فواتير (تحدث المباع تلقائياً) → التحقق من الكميات → إكمال (تنقص من الموجود)
```

## 🚀 الميزات المستقبلية

1. **تطبيق GPS** لتتبع الرحلات في الوقت الفعلي
2. **نظام جدولة ذكي** لتحسين المسارات
3. **تطبيق موبايل** للموزعين
4. **إشعارات تلقائية** للموظفين
5. **تحليل متقدم** للبيانات
6. **إدارة الوقود** ومصروفات السيارات
7. **تتبع الأداء** للموزعين
8. **تقارير مالية** مفصلة للتوزيع
