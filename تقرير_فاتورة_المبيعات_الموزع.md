# تقرير شامل: فاتورة المبيعات من نوع موزع (Distributor)

## 📋 نظرة عامة

فاتورة المبيعات من نوع موزع هي فاتورة مبيعات خاصة مرتبطة برحلة التوزيع. تختلف عن فواتير المبيعات العادية في أنها لا تؤثر على المخزون مباشرة، بل تُحدث الكميات المباعة في رحلة التوزيع.

## 🔧 APIs المتاحة

### 1. **إنشاء فاتورة مبيعات موزع**

**API:** `POST /api/SalesInvoice/CreateSalesInvoice`

**الملف:** `CreateSalesInvoiceCommandHandler.cs`

**المعاملات المطلوبة:**
```json
{
  "invoiceNumber": "INV-DIST-001",
  "customerId": 1,
  "invoiceDate": "2025-01-15",
  "totalAmount": 765.00,
  "discount": 0,
  "paymentMethod": "نقدي",
  "notes": "فاتورة توزيع",
  "type": "Distributor",           // ← نوع الموزع
  "distributionTripId": 1,         // ← ربط برحلة التوزيع
  "details": [
    {
      "productId": 1,
      "quantity": 30,
      "unitPrice": 25.50,
      "subTotal": 765.00,
      "notes": "طلب عادي"
    }
  ]
}
```

**تأثيره على النظام والكميات:**
- ✅ **إنشاء فاتورة مبيعات** جديدة
- ✅ **ربط الفاتورة برحلة التوزيع** (DistributionTrip)
- ✅ **تحديث SoldQty** في DistributionTripDetail تلقائياً
- ✅ **إضافة الفاتورة** إلى DistributionTripSalesInvoices
- ❌ **لا يؤثر على ProductBalance** (المخزون)
- ❌ **لا يؤثر على AvailableQty أو Qty**

**التحققات المطلوبة:**
- رحلة التوزيع موجودة
- رحلة التوزيع في حالة `GoodsReceived`
- الكمية المباعة لا تتجاوز الكمية المحملة
- المنتج موجود في تفاصيل رحلة التوزيع

---

### 2. **تحديث فاتورة مبيعات موزع**

**API:** `PUT /api/SalesInvoice/UpdateSalesInvoice`

**الملف:** `UpdateSalesInvoiceCommandHandler.cs`

**المعاملات:**
```json
{
  "id": 1,
  "invoiceNumber": "INV-DIST-001-UPDATED",
  "customerId": 1,
  "invoiceDate": "2025-01-15",
  "totalAmount": 800.00,
  "discount": 0,
  "paymentMethod": "شيك",
  "notes": "فاتورة توزيع محدثة"
}
```

**تأثيره على النظام والكميات:**
- ✅ **تحديث بيانات الفاتورة** (رقم، عميل، تاريخ، مبلغ، إلخ)
- ❌ **لا يؤثر على الكميات** في رحلة التوزيع
- ❌ **لا يؤثر على المخزون**
- ⚠️ **لا يمكن تحديث التفاصيل** (المنتجات والكميات)

---

### 3. **ترحيل فاتورة مبيعات موزع**

**API:** `PUT /api/SalesInvoice/PostSalesInvoice`

**الملف:** `PostSalesInvoiceCommandHandler.cs`

**المعاملات:**
```json
{
  "id": 1
}
```

**تأثيره على النظام والكميات:**
- ✅ **تغيير حالة الفاتورة** إلى `Posted`
- ❌ **لا يؤثر على المخزون** (فواتير الموزع مستثناة)
- ❌ **لا يؤثر على الكميات** في رحلة التوزيع
- ✅ **تسجيل في InventoryHistory** (للمتابعة فقط)

**ملاحظة مهمة:** فواتير الموزع لا تؤثر على المخزون عند الترحيل حسب الكود:
```csharp
// فواتير الموزّع لا تؤثر على المخزون هنا
if (invoice.Type == SalesInvoiceType.Distributor)
    return;
```

---

### 4. **حذف فاتورة مبيعات موزع**

**API:** `DELETE /api/SalesInvoice/DeleteSalesInvoice`

**الملف:** `DeleteSalesInvoiceCommandHandler.cs`

**المعاملات:**
```json
{
  "id": 1
}
```

**تأثيره على النظام والكميات:**
- ✅ **حذف الفاتورة** من قاعدة البيانات
- ❌ **لا يؤثر على الكميات** في رحلة التوزيع (SoldQty تبقى كما هي)
- ❌ **لا يؤثر على المخزون**
- ⚠️ **لا يتم تحديث SoldQty** في DistributionTripDetail

---

### 5. **عرض قائمة فواتير المبيعات**

**API:** `GET /api/SalesInvoice/GetPagedListSalesInvoice`

**الملف:** `GetPagedListSalesInvoiceQueryHandler.cs`

**المعاملات:**
```
?PageNumber=1&PageSize=10&InvoiceNumber=INV-DIST
```

**تأثيره على النظام والكميات:**
- ✅ **عرض قائمة الفواتير** مع Pagination
- ✅ **فلترة حسب رقم الفاتورة**
- ❌ **لا يؤثر على أي كميات**
- ✅ **عرض فواتير الموزع والعادية**

---

### 6. **عرض فاتورة مبيعات محددة**

**API:** `GET /api/SalesInvoice/GetSalesInvoiceById`

**الملف:** `GetSalesInvoiceByIdQueryHandler.cs`

**المعاملات:**
```
?id=1
```

**تأثيره على النظام والكميات:**
- ✅ **عرض تفاصيل الفاتورة** الكاملة
- ✅ **عرض تفاصيل المنتجات**
- ✅ **عرض معلومات رحلة التوزيع** (إذا كانت فاتورة موزع)
- ❌ **لا يؤثر على أي كميات**

---

## 🔗 العلاقة مع رحلة التوزيع

### في كيان SalesInvoice:
```csharp
public long? DistributionTripId { get; private set; }  // ربط برحلة التوزيع
public DistributionTrip DistributionTrip { get; private set; }
public SalesInvoiceType Type { get; private set; }    // Regular أو Distributor
```

### في كيان DistributionTrip:
```csharp
public List<SalesInvoice> DistributionTripSalesInvoices { get; private set; }
```

### العلاقة في قاعدة البيانات:
```csharp
// في DistributionTripConfiguration
builder.HasMany(p => p.DistributionTripSalesInvoices)
    .WithOne(i => i.DistributionTrip)
    .HasForeignKey(i => i.DistributionTripId)
    .OnDelete(DeleteBehavior.Restrict);
```

---

## 📊 تأثير الكميات على النظام

### 1. **عند إنشاء فاتورة موزع:**

| العنصر | التأثير | التفاصيل |
|--------|---------|----------|
| **ProductBalance** | ❌ لا تأثير | فواتير الموزع لا تؤثر على المخزون |
| **AvailableQty** | ❌ لا تأثير | لا تنقص من الكمية المتاحة |
| **Qty** | ❌ لا تأثير | لا تنقص من الكمية الموجودة |
| **SoldQty** | ✅ يزيد | يزيد في DistributionTripDetail |
| **DistributionTrip** | ✅ يربط | يضاف إلى DistributionTripSalesInvoices |

### 2. **عند ترحيل فاتورة موزع:**

| العنصر | التأثير | التفاصيل |
|--------|---------|----------|
| **ProductBalance** | ❌ لا تأثير | مستثناة في SalesInventoryService |
| **AvailableQty** | ❌ لا تأثير | لا تنقص من الكمية المتاحة |
| **Qty** | ❌ لا تأثير | لا تنقص من الكمية الموجودة |
| **SoldQty** | ❌ لا تأثير | تبقى كما هي |
| **Status** | ✅ يتغير | يصبح Posted |

### 3. **عند حذف فاتورة موزع:**

| العنصر | التأثير | التفاصيل |
|--------|---------|----------|
| **ProductBalance** | ❌ لا تأثير | لا يؤثر على المخزون |
| **SoldQty** | ❌ لا تأثير | **لا يتم تحديث** (مشكلة محتملة) |
| **DistributionTrip** | ❌ لا تأثير | **لا يتم إزالة** من القائمة (مشكلة محتملة) |

---

## ⚠️ المشاكل المحتملة

### 1. **مشكلة في حذف فاتورة موزع:**
- لا يتم تحديث `SoldQty` في `DistributionTripDetail`
- لا يتم إزالة الفاتورة من `DistributionTripSalesInvoices`
- **الحل المطلوب:** إضافة منطق لتحديث الكميات عند الحذف

### 2. **مشكلة في تحديث فاتورة موزع:**
- لا يمكن تحديث تفاصيل المنتجات والكميات
- **الحل المطلوب:** إضافة منطق لتحديث `SoldQty` عند تغيير الكميات

### 3. **عدم تأثير على المخزون:**
- فواتير الموزع لا تؤثر على `ProductBalance`
- هذا صحيح حسب التصميم، لكن يجب التأكد من أن المخزون يُحدث في مكان آخر

---

## 🎯 سيناريو العمل الكامل

### 1. **إنشاء فاتورة موزع:**
```
1. التحقق من رحلة التوزيع (موجودة + GoodsReceived)
2. إنشاء الفاتورة مع Type = Distributor
3. ربط الفاتورة برحلة التوزيع
4. تحديث SoldQty في DistributionTripDetail
5. إضافة الفاتورة إلى DistributionTripSalesInvoices
6. حفظ الفاتورة في قاعدة البيانات
```

### 2. **ترحيل فاتورة موزع:**
```
1. التحقق من وجود الفاتورة
2. تغيير الحالة إلى Posted
3. لا تأثير على المخزون (مستثناة)
4. تسجيل في InventoryHistory للمتابعة
```

### 3. **حذف فاتورة موزع:**
```
1. التحقق من وجود الفاتورة
2. حذف الفاتورة من قاعدة البيانات
3. ⚠️ لا يتم تحديث SoldQty (مشكلة)
4. ⚠️ لا يتم إزالة من DistributionTripSalesInvoices (مشكلة)
```

---

## 📈 التقارير المتاحة

### 1. **تقرير فواتير الموزعين:**
- فواتير مرتبطة برحلة توزيع محددة
- إجمالي المبيعات لكل موزع
- تحليل المبيعات حسب المنتج

### 2. **تقرير أداء الموزعين:**
- كميات مباعة من فواتير الموزع
- مقارنة مع الكميات المحملة
- نسبة المبيعات لكل موزع

### 3. **تقرير رحلة التوزيع:**
- فواتير المبيعات المرتبطة بالرحلة
- إجمالي المبيعات للرحلة
- تفاصيل كل فاتورة

---

## 🔧 التحسينات المقترحة

### 1. **إصلاح مشكلة الحذف:**
```csharp
// في DeleteSalesInvoiceCommandHandler
if (entity.Type == SalesInvoiceType.Distributor && entity.DistributionTripId.HasValue)
{
    // تحديث SoldQty في DistributionTripDetail
    // إزالة الفاتورة من DistributionTripSalesInvoices
}
```

### 2. **إضافة تحديث الكميات:**
```csharp
// في UpdateSalesInvoiceCommandHandler
if (entity.Type == SalesInvoiceType.Distributor)
{
    // تحديث SoldQty عند تغيير الكميات
}
```

### 3. **إضافة التحقق من الحالة:**
```csharp
// منع حذف أو تحديث فواتير Posted
if (entity.Status == SalesInvoiceStatus.Posted)
    return new Error(ErrorCode.FieldDataInvalid, "Cannot modify posted invoice");
```

---

## 🎯 الخلاصة

فاتورة المبيعات من نوع موزع هي نظام متكامل لإدارة مبيعات التوزيع مع ربطها برحلات التوزيع. النظام يعمل بشكل جيد في الإنشاء والترحيل، لكن يحتاج تحسينات في التحديث والحذف لضمان تناسق البيانات.

**النقاط الإيجابية:**
- ربط صحيح برحلة التوزيع
- تحديث تلقائي للكميات المباعة
- عدم تأثير على المخزون (صحيح حسب التصميم)
- تحققات شاملة من صحة البيانات

**النقاط التي تحتاج تحسين:**
- تحديث الكميات عند الحذف
- تحديث الكميات عند التعديل
- إزالة الفاتورة من رحلة التوزيع عند الحذف
- منع تعديل الفواتير المرحلة

---

*تم إعداد هذا التقرير بناءً على تحليل شامل لجميع ملفات النظام المتعلقة بفاتورة المبيعات من نوع موزع*
