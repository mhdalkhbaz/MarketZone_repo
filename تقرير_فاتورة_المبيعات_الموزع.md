# ุชูุฑูุฑ ุดุงูู: ูุงุชูุฑุฉ ุงููุจูุนุงุช ูู ููุน ููุฒุน (Distributor)

## ๐ ูุธุฑุฉ ุนุงูุฉ

ูุงุชูุฑุฉ ุงููุจูุนุงุช ูู ููุน ููุฒุน ูู ูุงุชูุฑุฉ ูุจูุนุงุช ุฎุงุตุฉ ูุฑุชุจุทุฉ ุจุฑุญูุฉ ุงูุชูุฒูุน. ุชุฎุชูู ุนู ููุงุชูุฑ ุงููุจูุนุงุช ุงูุนุงุฏูุฉ ูู ุฃููุง ูุง ุชุคุซุฑ ุนูู ุงููุฎุฒูู ูุจุงุดุฑุฉุ ุจู ุชูุญุฏุซ ุงููููุงุช ุงููุจุงุนุฉ ูู ุฑุญูุฉ ุงูุชูุฒูุน.

## ๐ง APIs ุงููุชุงุญุฉ

### 1. **ุฅูุดุงุก ูุงุชูุฑุฉ ูุจูุนุงุช ููุฒุน**

**API:** `POST /api/SalesInvoice/CreateSalesInvoice`

**ุงูููู:** `CreateSalesInvoiceCommandHandler.cs`

**ุงููุนุงููุงุช ุงููุทููุจุฉ:**
```json
{
  "invoiceNumber": "INV-DIST-001",
  "customerId": 1,
  "invoiceDate": "2025-01-15",
  "totalAmount": 765.00,
  "discount": 0,
  "paymentMethod": "ููุฏู",
  "notes": "ูุงุชูุฑุฉ ุชูุฒูุน",
  "type": "Distributor",           // โ ููุน ุงูููุฒุน
  "distributionTripId": 1,         // โ ุฑุจุท ุจุฑุญูุฉ ุงูุชูุฒูุน
  "details": [
    {
      "productId": 1,
      "quantity": 30,
      "unitPrice": 25.50,
      "subTotal": 765.00,
      "notes": "ุทูุจ ุนุงุฏู"
    }
  ]
}
```

**ุชุฃุซูุฑู ุนูู ุงููุธุงู ูุงููููุงุช:**
- โ **ุฅูุดุงุก ูุงุชูุฑุฉ ูุจูุนุงุช** ุฌุฏูุฏุฉ
- โ **ุฑุจุท ุงููุงุชูุฑุฉ ุจุฑุญูุฉ ุงูุชูุฒูุน** (DistributionTrip)
- โ **ุชุญุฏูุซ SoldQty** ูู DistributionTripDetail ุชููุงุฆูุงู
- โ **ุฅุถุงูุฉ ุงููุงุชูุฑุฉ** ุฅูู DistributionTripSalesInvoices
- โ **ูุง ูุคุซุฑ ุนูู ProductBalance** (ุงููุฎุฒูู)
- โ **ูุง ูุคุซุฑ ุนูู AvailableQty ุฃู Qty**

**ุงูุชุญููุงุช ุงููุทููุจุฉ:**
- ุฑุญูุฉ ุงูุชูุฒูุน ููุฌูุฏุฉ
- ุฑุญูุฉ ุงูุชูุฒูุน ูู ุญุงูุฉ `GoodsReceived`
- ุงููููุฉ ุงููุจุงุนุฉ ูุง ุชุชุฌุงูุฒ ุงููููุฉ ุงููุญููุฉ
- ุงูููุชุฌ ููุฌูุฏ ูู ุชูุงุตูู ุฑุญูุฉ ุงูุชูุฒูุน

---

### 2. **ุชุญุฏูุซ ูุงุชูุฑุฉ ูุจูุนุงุช ููุฒุน**

**API:** `PUT /api/SalesInvoice/UpdateSalesInvoice`

**ุงูููู:** `UpdateSalesInvoiceCommandHandler.cs`

**ุงููุนุงููุงุช:**
```json
{
  "id": 1,
  "invoiceNumber": "INV-DIST-001-UPDATED",
  "customerId": 1,
  "invoiceDate": "2025-01-15",
  "totalAmount": 800.00,
  "discount": 0,
  "paymentMethod": "ุดูู",
  "notes": "ูุงุชูุฑุฉ ุชูุฒูุน ูุญุฏุซุฉ"
}
```

**ุชุฃุซูุฑู ุนูู ุงููุธุงู ูุงููููุงุช:**
- โ **ุชุญุฏูุซ ุจูุงูุงุช ุงููุงุชูุฑุฉ** (ุฑููุ ุนูููุ ุชุงุฑูุฎุ ูุจูุบุ ุฅูุฎ)
- โ **ูุง ูุคุซุฑ ุนูู ุงููููุงุช** ูู ุฑุญูุฉ ุงูุชูุฒูุน
- โ **ูุง ูุคุซุฑ ุนูู ุงููุฎุฒูู**
- โ๏ธ **ูุง ูููู ุชุญุฏูุซ ุงูุชูุงุตูู** (ุงูููุชุฌุงุช ูุงููููุงุช)

---

### 3. **ุชุฑุญูู ูุงุชูุฑุฉ ูุจูุนุงุช ููุฒุน**

**API:** `PUT /api/SalesInvoice/PostSalesInvoice`

**ุงูููู:** `PostSalesInvoiceCommandHandler.cs`

**ุงููุนุงููุงุช:**
```json
{
  "id": 1
}
```

**ุชุฃุซูุฑู ุนูู ุงููุธุงู ูุงููููุงุช:**
- โ **ุชุบููุฑ ุญุงูุฉ ุงููุงุชูุฑุฉ** ุฅูู `Posted`
- โ **ูุง ูุคุซุฑ ุนูู ุงููุฎุฒูู** (ููุงุชูุฑ ุงูููุฒุน ูุณุชุซูุงุฉ)
- โ **ูุง ูุคุซุฑ ุนูู ุงููููุงุช** ูู ุฑุญูุฉ ุงูุชูุฒูุน
- โ **ุชุณุฌูู ูู InventoryHistory** (ูููุชุงุจุนุฉ ููุท)

**ููุงุญุธุฉ ูููุฉ:** ููุงุชูุฑ ุงูููุฒุน ูุง ุชุคุซุฑ ุนูู ุงููุฎุฒูู ุนูุฏ ุงูุชุฑุญูู ุญุณุจ ุงูููุฏ:
```csharp
// ููุงุชูุฑ ุงูููุฒูุน ูุง ุชุคุซุฑ ุนูู ุงููุฎุฒูู ููุง
if (invoice.Type == SalesInvoiceType.Distributor)
    return;
```

---

### 4. **ุญุฐู ูุงุชูุฑุฉ ูุจูุนุงุช ููุฒุน**

**API:** `DELETE /api/SalesInvoice/DeleteSalesInvoice`

**ุงูููู:** `DeleteSalesInvoiceCommandHandler.cs`

**ุงููุนุงููุงุช:**
```json
{
  "id": 1
}
```

**ุชุฃุซูุฑู ุนูู ุงููุธุงู ูุงููููุงุช:**
- โ **ุญุฐู ุงููุงุชูุฑุฉ** ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- โ **ูุง ูุคุซุฑ ุนูู ุงููููุงุช** ูู ุฑุญูุฉ ุงูุชูุฒูุน (SoldQty ุชุจูู ููุง ูู)
- โ **ูุง ูุคุซุฑ ุนูู ุงููุฎุฒูู**
- โ๏ธ **ูุง ูุชู ุชุญุฏูุซ SoldQty** ูู DistributionTripDetail

---

### 5. **ุนุฑุถ ูุงุฆูุฉ ููุงุชูุฑ ุงููุจูุนุงุช**

**API:** `GET /api/SalesInvoice/GetPagedListSalesInvoice`

**ุงูููู:** `GetPagedListSalesInvoiceQueryHandler.cs`

**ุงููุนุงููุงุช:**
```
?PageNumber=1&PageSize=10&InvoiceNumber=INV-DIST
```

**ุชุฃุซูุฑู ุนูู ุงููุธุงู ูุงููููุงุช:**
- โ **ุนุฑุถ ูุงุฆูุฉ ุงูููุงุชูุฑ** ูุน Pagination
- โ **ููุชุฑุฉ ุญุณุจ ุฑูู ุงููุงุชูุฑุฉ**
- โ **ูุง ูุคุซุฑ ุนูู ุฃู ูููุงุช**
- โ **ุนุฑุถ ููุงุชูุฑ ุงูููุฒุน ูุงูุนุงุฏูุฉ**

---

### 6. **ุนุฑุถ ูุงุชูุฑุฉ ูุจูุนุงุช ูุญุฏุฏุฉ**

**API:** `GET /api/SalesInvoice/GetSalesInvoiceById`

**ุงูููู:** `GetSalesInvoiceByIdQueryHandler.cs`

**ุงููุนุงููุงุช:**
```
?id=1
```

**ุชุฃุซูุฑู ุนูู ุงููุธุงู ูุงููููุงุช:**
- โ **ุนุฑุถ ุชูุงุตูู ุงููุงุชูุฑุฉ** ุงููุงููุฉ
- โ **ุนุฑุถ ุชูุงุตูู ุงูููุชุฌุงุช**
- โ **ุนุฑุถ ูุนูููุงุช ุฑุญูุฉ ุงูุชูุฒูุน** (ุฅุฐุง ูุงูุช ูุงุชูุฑุฉ ููุฒุน)
- โ **ูุง ูุคุซุฑ ุนูู ุฃู ูููุงุช**

---

## ๐ ุงูุนูุงูุฉ ูุน ุฑุญูุฉ ุงูุชูุฒูุน

### ูู ููุงู SalesInvoice:
```csharp
public long? DistributionTripId { get; private set; }  // ุฑุจุท ุจุฑุญูุฉ ุงูุชูุฒูุน
public DistributionTrip DistributionTrip { get; private set; }
public SalesInvoiceType Type { get; private set; }    // Regular ุฃู Distributor
```

### ูู ููุงู DistributionTrip:
```csharp
public List<SalesInvoice> DistributionTripSalesInvoices { get; private set; }
```

### ุงูุนูุงูุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช:
```csharp
// ูู DistributionTripConfiguration
builder.HasMany(p => p.DistributionTripSalesInvoices)
    .WithOne(i => i.DistributionTrip)
    .HasForeignKey(i => i.DistributionTripId)
    .OnDelete(DeleteBehavior.Restrict);
```

---

## ๐ ุชุฃุซูุฑ ุงููููุงุช ุนูู ุงููุธุงู

### 1. **ุนูุฏ ุฅูุดุงุก ูุงุชูุฑุฉ ููุฒุน:**

| ุงูุนูุตุฑ | ุงูุชุฃุซูุฑ | ุงูุชูุงุตูู |
|--------|---------|----------|
| **ProductBalance** | โ ูุง ุชุฃุซูุฑ | ููุงุชูุฑ ุงูููุฒุน ูุง ุชุคุซุฑ ุนูู ุงููุฎุฒูู |
| **AvailableQty** | โ ูุง ุชุฃุซูุฑ | ูุง ุชููุต ูู ุงููููุฉ ุงููุชุงุญุฉ |
| **Qty** | โ ูุง ุชุฃุซูุฑ | ูุง ุชููุต ูู ุงููููุฉ ุงูููุฌูุฏุฉ |
| **SoldQty** | โ ูุฒูุฏ | ูุฒูุฏ ูู DistributionTripDetail |
| **DistributionTrip** | โ ูุฑุจุท | ูุถุงู ุฅูู DistributionTripSalesInvoices |

### 2. **ุนูุฏ ุชุฑุญูู ูุงุชูุฑุฉ ููุฒุน:**

| ุงูุนูุตุฑ | ุงูุชุฃุซูุฑ | ุงูุชูุงุตูู |
|--------|---------|----------|
| **ProductBalance** | โ ูุง ุชุฃุซูุฑ | ูุณุชุซูุงุฉ ูู SalesInventoryService |
| **AvailableQty** | โ ูุง ุชุฃุซูุฑ | ูุง ุชููุต ูู ุงููููุฉ ุงููุชุงุญุฉ |
| **Qty** | โ ูุง ุชุฃุซูุฑ | ูุง ุชููุต ูู ุงููููุฉ ุงูููุฌูุฏุฉ |
| **SoldQty** | โ ูุง ุชุฃุซูุฑ | ุชุจูู ููุง ูู |
| **Status** | โ ูุชุบูุฑ | ูุตุจุญ Posted |

### 3. **ุนูุฏ ุญุฐู ูุงุชูุฑุฉ ููุฒุน:**

| ุงูุนูุตุฑ | ุงูุชุฃุซูุฑ | ุงูุชูุงุตูู |
|--------|---------|----------|
| **ProductBalance** | โ ูุง ุชุฃุซูุฑ | ูุง ูุคุซุฑ ุนูู ุงููุฎุฒูู |
| **SoldQty** | โ ูุง ุชุฃุซูุฑ | **ูุง ูุชู ุชุญุฏูุซ** (ูุดููุฉ ูุญุชููุฉ) |
| **DistributionTrip** | โ ูุง ุชุฃุซูุฑ | **ูุง ูุชู ุฅุฒุงูุฉ** ูู ุงููุงุฆูุฉ (ูุดููุฉ ูุญุชููุฉ) |

---

## โ๏ธ ุงููุดุงูู ุงููุญุชููุฉ

### 1. **ูุดููุฉ ูู ุญุฐู ูุงุชูุฑุฉ ููุฒุน:**
- ูุง ูุชู ุชุญุฏูุซ `SoldQty` ูู `DistributionTripDetail`
- ูุง ูุชู ุฅุฒุงูุฉ ุงููุงุชูุฑุฉ ูู `DistributionTripSalesInvoices`
- **ุงูุญู ุงููุทููุจ:** ุฅุถุงูุฉ ููุทู ูุชุญุฏูุซ ุงููููุงุช ุนูุฏ ุงูุญุฐู

### 2. **ูุดููุฉ ูู ุชุญุฏูุซ ูุงุชูุฑุฉ ููุฒุน:**
- ูุง ูููู ุชุญุฏูุซ ุชูุงุตูู ุงูููุชุฌุงุช ูุงููููุงุช
- **ุงูุญู ุงููุทููุจ:** ุฅุถุงูุฉ ููุทู ูุชุญุฏูุซ `SoldQty` ุนูุฏ ุชุบููุฑ ุงููููุงุช

### 3. **ุนุฏู ุชุฃุซูุฑ ุนูู ุงููุฎุฒูู:**
- ููุงุชูุฑ ุงูููุฒุน ูุง ุชุคุซุฑ ุนูู `ProductBalance`
- ูุฐุง ุตุญูุญ ุญุณุจ ุงูุชุตูููุ ููู ูุฌุจ ุงูุชุฃูุฏ ูู ุฃู ุงููุฎุฒูู ููุญุฏุซ ูู ููุงู ุขุฎุฑ

---

## ๐ฏ ุณููุงุฑูู ุงูุนูู ุงููุงูู

### 1. **ุฅูุดุงุก ูุงุชูุฑุฉ ููุฒุน:**
```
1. ุงูุชุญูู ูู ุฑุญูุฉ ุงูุชูุฒูุน (ููุฌูุฏุฉ + GoodsReceived)
2. ุฅูุดุงุก ุงููุงุชูุฑุฉ ูุน Type = Distributor
3. ุฑุจุท ุงููุงุชูุฑุฉ ุจุฑุญูุฉ ุงูุชูุฒูุน
4. ุชุญุฏูุซ SoldQty ูู DistributionTripDetail
5. ุฅุถุงูุฉ ุงููุงุชูุฑุฉ ุฅูู DistributionTripSalesInvoices
6. ุญูุธ ุงููุงุชูุฑุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
```

### 2. **ุชุฑุญูู ูุงุชูุฑุฉ ููุฒุน:**
```
1. ุงูุชุญูู ูู ูุฌูุฏ ุงููุงุชูุฑุฉ
2. ุชุบููุฑ ุงูุญุงูุฉ ุฅูู Posted
3. ูุง ุชุฃุซูุฑ ุนูู ุงููุฎุฒูู (ูุณุชุซูุงุฉ)
4. ุชุณุฌูู ูู InventoryHistory ูููุชุงุจุนุฉ
```

### 3. **ุญุฐู ูุงุชูุฑุฉ ููุฒุน:**
```
1. ุงูุชุญูู ูู ูุฌูุฏ ุงููุงุชูุฑุฉ
2. ุญุฐู ุงููุงุชูุฑุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
3. โ๏ธ ูุง ูุชู ุชุญุฏูุซ SoldQty (ูุดููุฉ)
4. โ๏ธ ูุง ูุชู ุฅุฒุงูุฉ ูู DistributionTripSalesInvoices (ูุดููุฉ)
```

---

## ๐ ุงูุชูุงุฑูุฑ ุงููุชุงุญุฉ

### 1. **ุชูุฑูุฑ ููุงุชูุฑ ุงูููุฒุนูู:**
- ููุงุชูุฑ ูุฑุชุจุทุฉ ุจุฑุญูุฉ ุชูุฒูุน ูุญุฏุฏุฉ
- ุฅุฌูุงูู ุงููุจูุนุงุช ููู ููุฒุน
- ุชุญููู ุงููุจูุนุงุช ุญุณุจ ุงูููุชุฌ

### 2. **ุชูุฑูุฑ ุฃุฏุงุก ุงูููุฒุนูู:**
- ูููุงุช ูุจุงุนุฉ ูู ููุงุชูุฑ ุงูููุฒุน
- ููุงุฑูุฉ ูุน ุงููููุงุช ุงููุญููุฉ
- ูุณุจุฉ ุงููุจูุนุงุช ููู ููุฒุน

### 3. **ุชูุฑูุฑ ุฑุญูุฉ ุงูุชูุฒูุน:**
- ููุงุชูุฑ ุงููุจูุนุงุช ุงููุฑุชุจุทุฉ ุจุงูุฑุญูุฉ
- ุฅุฌูุงูู ุงููุจูุนุงุช ููุฑุญูุฉ
- ุชูุงุตูู ูู ูุงุชูุฑุฉ

---

## ๐ง ุงูุชุญุณููุงุช ุงูููุชุฑุญุฉ

### 1. **ุฅุตูุงุญ ูุดููุฉ ุงูุญุฐู:**
```csharp
// ูู DeleteSalesInvoiceCommandHandler
if (entity.Type == SalesInvoiceType.Distributor && entity.DistributionTripId.HasValue)
{
    // ุชุญุฏูุซ SoldQty ูู DistributionTripDetail
    // ุฅุฒุงูุฉ ุงููุงุชูุฑุฉ ูู DistributionTripSalesInvoices
}
```

### 2. **ุฅุถุงูุฉ ุชุญุฏูุซ ุงููููุงุช:**
```csharp
// ูู UpdateSalesInvoiceCommandHandler
if (entity.Type == SalesInvoiceType.Distributor)
{
    // ุชุญุฏูุซ SoldQty ุนูุฏ ุชุบููุฑ ุงููููุงุช
}
```

### 3. **ุฅุถุงูุฉ ุงูุชุญูู ูู ุงูุญุงูุฉ:**
```csharp
// ููุน ุญุฐู ุฃู ุชุญุฏูุซ ููุงุชูุฑ Posted
if (entity.Status == SalesInvoiceStatus.Posted)
    return new Error(ErrorCode.FieldDataInvalid, "Cannot modify posted invoice");
```

---

## ๐ฏ ุงูุฎูุงุตุฉ

ูุงุชูุฑุฉ ุงููุจูุนุงุช ูู ููุน ููุฒุน ูู ูุธุงู ูุชูุงูู ูุฅุฏุงุฑุฉ ูุจูุนุงุช ุงูุชูุฒูุน ูุน ุฑุจุทูุง ุจุฑุญูุงุช ุงูุชูุฒูุน. ุงููุธุงู ูุนูู ุจุดูู ุฌูุฏ ูู ุงูุฅูุดุงุก ูุงูุชุฑุญููุ ููู ูุญุชุงุฌ ุชุญุณููุงุช ูู ุงูุชุญุฏูุซ ูุงูุญุฐู ูุถูุงู ุชูุงุณู ุงูุจูุงูุงุช.

**ุงูููุงุท ุงูุฅูุฌุงุจูุฉ:**
- ุฑุจุท ุตุญูุญ ุจุฑุญูุฉ ุงูุชูุฒูุน
- ุชุญุฏูุซ ุชููุงุฆู ูููููุงุช ุงููุจุงุนุฉ
- ุนุฏู ุชุฃุซูุฑ ุนูู ุงููุฎุฒูู (ุตุญูุญ ุญุณุจ ุงูุชุตููู)
- ุชุญููุงุช ุดุงููุฉ ูู ุตุญุฉ ุงูุจูุงูุงุช

**ุงูููุงุท ุงูุชู ุชุญุชุงุฌ ุชุญุณูู:**
- ุชุญุฏูุซ ุงููููุงุช ุนูุฏ ุงูุญุฐู
- ุชุญุฏูุซ ุงููููุงุช ุนูุฏ ุงูุชุนุฏูู
- ุฅุฒุงูุฉ ุงููุงุชูุฑุฉ ูู ุฑุญูุฉ ุงูุชูุฒูุน ุนูุฏ ุงูุญุฐู
- ููุน ุชุนุฏูู ุงูููุงุชูุฑ ุงููุฑุญูุฉ

---

*ุชู ุฅุนุฏุงุฏ ูุฐุง ุงูุชูุฑูุฑ ุจูุงุกู ุนูู ุชุญููู ุดุงูู ูุฌููุน ูููุงุช ุงููุธุงู ุงููุชุนููุฉ ุจูุงุชูุฑุฉ ุงููุจูุนุงุช ูู ููุน ููุฒุน*
