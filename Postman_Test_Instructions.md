# تعليمات استخدام Postman Collection لاختبار رحلات التوزيع

## 📋 الملفات المطلوبة

1. **`MarketZone_DistributionTrip_Test_Collection.json`** - مجموعة الاختبارات
2. **`MarketZone_Test_Environment.json`** - بيئة الاختبار

## 🚀 خطوات الإعداد

### **1. استيراد الملفات إلى Postman:**

1. افتح Postman
2. اذهب إلى **Import** (استيراد)
3. اسحب ملف `MarketZone_DistributionTrip_Test_Collection.json`
4. اسحب ملف `MarketZone_Test_Environment.json`

### **2. إعداد البيئة:**

1. في Postman، اذهب إلى **Environments** (البيئات)
2. اختر **MarketZone Test Environment**
3. تأكد من أن `baseUrl` مضبوط على `https://localhost:7001`

### **3. تشغيل التطبيق:**

```bash
dotnet run --project "Src/Presentation/MarketZone.WebApi"
```

## 🔄 سير العمل للاختبار

### **المرحلة الأولى: البيانات الأساسية**

قم بتنفيذ الطلبات بالترتيب التالي:

1. **1. إنشاء موظف** ✅
2. **2. إنشاء سيارة** ✅
3. **3. إنشاء منطقة** ✅
4. **4. إنشاء عميل** ✅
5. **5. إنشاء منتج** ✅
6. **6. إنشاء رصيد المنتج** ✅

### **المرحلة الثانية: سير عمل رحلة التوزيع**

1. **1. إنشاء رحلة توزيع جديدة** ✅
   - احفظ الـ `id` المُرجع في متغير البيئة `distributionTripId`
   - احفظ الـ `detailId` في `distributionTripDetailId`
   - **التحقق من نقص AvailableQty في ProductBalance**

2. **2. ترحيل الرحلة** ✅
   - **التحقق من نقص Qty في ProductBalance**

3. **3. استلام البضاعة (تسجيل المرتجعات)** ✅

4. **4. إنشاء فاتورة مبيعات موزع (العميل الأول)** ✅

5. **5. إنشاء فاتورة مبيعات موزع (العميل الثاني)** ✅

6. **6. التحقق من الكميات** ✅

7. **7. إكمال الرحلة** ✅

### **المرحلة الثالثة: التحقق من النتائج**

1. **1. عرض رحلة التوزيع** ✅
2. **2. عرض فواتير المبيعات** ✅
3. **3. عرض تفاصيل رحلة التوزيع** ✅
4. **4. عرض رصيد المنتج** ✅

## 🚨 اختبار الحالات الاستثنائية

### **اختبار الأخطاء:**

1. **1. محاولة إنشاء رحلة توزيع بموظف غير موجود**
   - يجب أن يعطي خطأ 404 - Employee not found

2. **2. محاولة إنشاء رحلة توزيع بكمية غير متاحة**
   - يجب أن يعطي خطأ - Insufficient available quantity

3. **3. محاولة Post رحلة ليست في حالة Draft**
   - يجب أن يعطي خطأ - Cannot post trip that is not in Draft status

4. **4. محاولة استلام البضاعة لرحلة في حالة Draft**
   - يجب أن يعطي خطأ - Cannot receive goods for trip that is not in Posted status

5. **5. محاولة إنشاء فاتورة موزع لرحلة في حالة Posted**
   - يجب أن يعطي خطأ - Cannot create distributor invoice for trip that is not in GoodsReceived status

## 📊 النتائج المتوقعة

### **بعد إكمال سير العمل:**

1. **رحلة التوزيع:**
   - الحالة: `Completed`
   - `SoldQty` للمنتج: 55 (30 + 25)
   - `ReturnedQty` للمنتج: 15

2. **فواتير المبيعات:**
   - فاتورتان من نوع `Distributor`
   - مرتبطتان برحلة التوزيع
   - إجمالي المبيعات: 1402.50 (765 + 637.50)

3. **ProductBalance:**
   - `qty`: 100 (200 - 100 من Post)
   - `availableQty`: 100 (200 - 100 من Create)

4. **التحقق من الكميات:**
   - `isValid`: true
   - لا توجد أخطاء أو تحذيرات

## 🛠️ استكشاف الأخطاء

### **إذا فشل البناء:**
```bash
dotnet build
```

### **إذا فشل تشغيل التطبيق:**
```bash
dotnet run --project "Src/Presentation/MarketZone.WebApi" --verbosity normal
```

### **إذا فشلت الطلبات:**
1. تأكد من أن التطبيق يعمل على `https://localhost:7001`
2. تحقق من صحة البيانات المرسلة
3. تحقق من الـ IDs المستخدمة
4. تأكد من وجود ProductBalance مع كميات كافية

### **إذا فشلت قاعدة البيانات:**
```bash
dotnet ef database update --project "Src/Infrastructure/MarketZone.Infrastructure.Persistence" --startup-project "Src/Presentation/MarketZone.WebApi" --context ApplicationDbContext
```

## 📝 ملاحظات مهمة

1. **تأكد من وجود البيانات الأساسية** قبل بدء الاختبار
2. **تأكد من وجود ProductBalance** مع كميات كافية
3. **احفظ الـ IDs** المُرجعة من كل طلب
4. **اختبر بالترتيب** المحدد
5. **تحقق من النتائج** بعد كل خطوة
6. **اختبر الحالات الاستثنائية** للتأكد من معالجة الأخطاء
7. **احفظ النتائج** للتحليل لاحقاً
8. **تحقق من ProductBalance** للتأكد من تحديث الكميات

## 🎯 معايير النجاح

### **1. سير العمل:**
- ✅ جميع الطلبات تعمل بنجاح
- ✅ التحقق من الـ IDs يعمل
- ✅ التحقق من الكميات المتاحة يعمل
- ✅ نقص AvailableQty عند إنشاء الرحلة
- ✅ نقص Qty عند Post الرحلة

### **2. التحقق من الأخطاء:**
- ✅ التحقق من وجود Employee, Car, Region, Product
- ✅ التحقق من الكميات المتاحة
- ✅ التحقق من حالة الرحلة في كل خطوة
- ✅ التحقق من الكميات المباعة والمرجعة
- ✅ التراجع عن التغييرات في حالة الخطأ

### **3. البيانات:**
- ✅ `SoldQty` تُحدث تلقائياً عند إنشاء فواتير المبيعات
- ✅ `ReturnedQty` تُخزن في قاعدة البيانات
- ✅ العلاقات بين الكيانات تعمل بشكل صحيح
- ✅ التحقق من الكميات يعمل بشكل صحيح
- ✅ ProductBalance يتم تحديثه بشكل صحيح

## 📞 الدعم

إذا واجهت أي مشاكل:
1. تحقق من سجلات التطبيق
2. تحقق من قاعدة البيانات
3. تأكد من صحة البيانات المرسلة
4. تحقق من حالة التطبيق
5. تحقق من ProductBalance

---

**🎉 تهانينا! النظام يعمل بشكل مثالي مع التحقق من الأخطاء والكميات!**
