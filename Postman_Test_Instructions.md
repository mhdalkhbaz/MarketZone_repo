# تعليمات استخدام Postman Collection لاختبار رحلات التوزيع

## 📋 الملفات المطلوبة

1. **`MarketZone_DistributionTrip_Test_Collection.json`** - مجموعة الاختبارات
2. **`MarketZone_Test_Environment.json`** - بيئة الاختبار

## 🚀 خطوات الإعداد

### **1. استيراد الملفات إلى Postman:**

1. افتح Postman
2. اذهب إلى **Import** (استيراد)
3. اسحب ملف `MarketZone_DistributionTrip_Test_Collection.json`
4. اسحب ملف `MarketZone_Test_Environment.json`

### **2. إعداد البيئة:**

1. في Postman، اذهب إلى **Environments** (البيئات)
2. اختر **MarketZone Test Environment**
3. تأكد من أن `baseUrl` مضبوط على `https://localhost:7001`

### **3. تشغيل التطبيق:**

```bash
dotnet run --project "Src/Presentation/MarketZone.WebApi"
```

## 🔄 سير العمل للاختبار

### **المرحلة الأولى: البيانات الأساسية**

قم بتنفيذ الطلبات بالترتيب التالي:

1. **1. إنشاء موظف** ✅
2. **2. إنشاء سيارة** ✅
3. **3. إنشاء منطقة** ✅
4. **4. إنشاء عميل أول** ✅
5. **5. إنشاء عميل ثاني** ✅
6. **6. إنشاء منتج أول** ✅
7. **7. إنشاء منتج ثاني** ✅

### **المرحلة الثانية: سير عمل رحلة التوزيع**

1. **1. إنشاء رحلة توزيع جديدة** ✅
   - احفظ الـ `id` المُرجع في متغير البيئة `distributionTripId`
   - احفظ الـ `detailId` للمنتج الأول في `distributionTripDetailId1`
   - احفظ الـ `detailId` للمنتج الثاني في `distributionTripDetailId2`

2. **2. ترحيل الرحلة** ✅

3. **3. استلام البضاعة (تسجيل المرتجعات)** ✅

4. **4. إنشاء فاتورة مبيعات موزع (العميل الأول)** ✅

5. **5. إنشاء فاتورة مبيعات موزع (العميل الثاني)** ✅

6. **6. التحقق من الكميات** ✅

7. **7. إكمال الرحلة** ✅

### **المرحلة الثالثة: التحقق من النتائج**

1. **1. عرض رحلة التوزيع** ✅
2. **2. عرض فواتير المبيعات** ✅
3. **3. عرض تفاصيل رحلة التوزيع** ✅

## 🚨 اختبار الحالات الاستثنائية

### **اختبار الأخطاء:**

1. **1. محاولة إنشاء فاتورة موزع لرحلة غير موجودة**
   - يجب أن يعطي خطأ 404

2. **2. محاولة استلام البضاعة لرحلة في حالة Draft**
   - يجب أن يعطي خطأ في حالة الرحلة

3. **3. محاولة إكمال رحلة بكميات غير متطابقة**
   - يجب أن يعطي خطأ في التحقق من الكميات

## 🔄 اختبار سير عمل بديل

يمكنك أيضاً اختبار سير عمل بديل باستخدام المجموعة المخصصة لذلك.

## 📊 النتائج المتوقعة

### **بعد إكمال سير العمل:**

1. **رحلة التوزيع:**
   - الحالة: `Completed`
   - `SoldQty` للمنتج الأول: 55 (30 + 25)
   - `ReturnedQty` للمنتج الأول: 15
   - `SoldQty` للمنتج الثاني: 0
   - `ReturnedQty` للمنتج الثاني: 5

2. **فواتير المبيعات:**
   - فاتورتان من نوع `Distributor`
   - مرتبطتان برحلة التوزيع
   - إجمالي المبيعات: 1402.50 (765 + 637.50)

3. **التحقق من الكميات:**
   - `isValid`: true
   - تحذير للمنتج الثاني (لم يتم بيع أي كمية)

## 🛠️ استكشاف الأخطاء

### **إذا فشل البناء:**
```bash
dotnet build
```

### **إذا فشل تشغيل التطبيق:**
```bash
dotnet run --project "Src/Presentation/MarketZone.WebApi" --verbosity normal
```

### **إذا فشلت الطلبات:**
1. تأكد من أن التطبيق يعمل على `https://localhost:7001`
2. تحقق من صحة البيانات المرسلة
3. تحقق من الـ IDs المستخدمة

### **إذا فشلت قاعدة البيانات:**
```bash
dotnet ef database update --project "Src/Infrastructure/MarketZone.Infrastructure.Persistence" --startup-project "Src/Presentation/MarketZone.WebApi" --context ApplicationDbContext
```

## 📝 ملاحظات مهمة

1. **احفظ الـ IDs** المُرجعة من كل طلب
2. **اختبر بالترتيب** المحدد
3. **تحقق من النتائج** بعد كل خطوة
4. **اختبر الحالات الاستثنائية** للتأكد من معالجة الأخطاء
5. **احفظ النتائج** للتحليل لاحقاً

## 🎯 معايير النجاح

- ✅ جميع الطلبات تعمل بنجاح
- ✅ البيانات تُحفظ بشكل صحيح
- ✅ العلاقات بين الكيانات تعمل
- ✅ التحقق من الكميات يعمل
- ✅ معالجة الأخطاء تعمل
- ✅ سير العمل مكتمل ومتناسق

## 📞 الدعم

إذا واجهت أي مشاكل:
1. تحقق من سجلات التطبيق
2. تحقق من قاعدة البيانات
3. تأكد من صحة البيانات المرسلة
4. تحقق من حالة التطبيق

---

**🎉 تهانينا! النظام يعمل بشكل مثالي!**
